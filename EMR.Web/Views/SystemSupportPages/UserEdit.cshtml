@{
    ViewBag.Title = "用户编辑";
    Layout = "~/Views/Shared/_Edit_Layout.cshtml";
}

<form class="layui-form" id="form1" action="">
    <div id="action_subm">
        <div class="submEdit">
            <div class="layui-form-item">
                <label class="layui-form-label cur_lable">组织机构代码</label>
                <div class="layui-input-inline">
                    <select name="OrganID" id="OrganID" data-id="OrganID" class="deletSele" lay-verify="SelectRequired" placeholder="请选择组织机构代码">
                        <option value="0">请选择组织机构代码</option>
                    </select>
                </div>
                <label class="layui-form-label cur_lable">用户编号</label>
                <div class="layui-input-inline">
                    <input type="text" name="UserCode" data-id="UserCode" lay-verify="required" lay-maxlength="20" placeholder="请输入用户编号" autocomplete="off"
                           class="layui-input">
                </div>
            </div>
            <div class="layui-form-item">
                <label class="layui-form-label">HIS编号</label>
                <div class="layui-input-inline">
                    <input type="text" name="HISCode" data-id="HISCode"  lay-maxlength="20" placeholder="请输入HIS编号" autocomplete="off"
                           class="layui-input">
                </div>
                <label class="layui-form-label">用户名称</label>
                <div class="layui-input-inline">
                    <input type="text" name="UserName" data-id="UserName" lay-verify="required" lay-maxlength="20" placeholder="请输入用户名称" autocomplete="off"
                           class="layui-input">
                </div>
            </div>
            <div class="layui-form-item">
                <label class="layui-form-label">职务</label>
                <div class="layui-input-inline">
                    <select name="Job" id="Job" class="deletSele" lay-verify="required" placeholder="请选择职务"></select>
                </div>
                <label class="layui-form-label">职务级别</label>
                <div class="layui-input-inline">
                    <select name="JobLevel" id="JobLevel" class="deletSele" lay-verify="SelectRequired" placeholder="请选择职务级别"></select>
                </div>
            </div>
            <div class="layui-form-item">
                <label class="layui-form-label">用户职称</label>
                <div class="layui-input-inline">
                    <select name="UserPosition" id="UserPosition" class="deletSele" lay-verify="SelectRequired" placeholder="请选择职务"></select>
                </div>
                <label class="layui-form-label">用户人员性别</label>
                <div class="layui-input-inline" id="divUserSex">
                    <input type="radio" name="UserSex" value="1" title="男">男
                    <input type="radio" name="UserSex" value="2" title="女">女
                    <input type="radio" name="UserSex" value="3" title="保密">保密
                </div>
            </div>
            <div class="layui-form-item">
                <label class="layui-form-label">用户人员电话</label>
                <div class="layui-input-inline">
                    <input type="text" name="UserTel" data-id="UserTel" placeholder="请输入用户人员电话" autocomplete="off"
                           class="layui-input"> @*lay-verify="phone"*@
                    </div>
                    <label class="layui-form-label">用户出生日期</label>
                    <div class="layui-input-inline">
                        <input type="text" name="UserBirthday" data-id="UserBirthday" id="UserBirthday" lay-verify="date" placeholder="请输入用户出生日期" autocomplete="off" class="layui-input">
                    </div>
                </div>
               
                <div class="layui-form-item">
                    <label class="layui-form-label">是否超级用户</label>
                    <div class="layui-input-inline">
                        <input type="radio" name="IsSuper" value="1" title="是">是
                        <input type="radio" name="IsSuper" value="0" title="否" checked="">否
                    </div>

                    <label class="layui-form-label">是否作废</label>
                    <div class="layui-input-inline">
                        <input type="radio" name="IsCance" value="1" title="作废">作废
                        <input type="radio" name="IsCance" value="0" title="正常" checked="">正常
                    </div>
                </div>
                <div class="layui-form-item">
                    <label class="layui-form-label">用户照片</label>
                    <div class="layui-input-inline">
                        <div class="layui-upload uploadPictures">
                            <div class="layui-upload-list uploadImg">
                                <img id="image" src="~/Content/images/upload_img.png"
                                     width="100" style="cursor: pointer;" />
                                <input id="picture_upload" name="file" type="file" onchange="upload_cover(this)"
                                       style="position: absolute; left: 0px; top: 0px; width: 100px; height: 100px; opacity: 0; cursor: pointer;" />
                                <input type="hidden" value="" name="UserPhoto" id="UserPhoto" data-id="UserPhoto" />
                            </div>
                        </div>
                    </div>
                    <label class="layui-form-label" id="labPASSWORD">登录密码</label>
                    <div class="layui-input-inline" id="divPASSWORD">
                        <input type="text" name="PassWord" id="PassWord" data-id="PassWord" lay-maxlength="20" placeholder="请输入登录密码" autocomplete="off"
                               class="layui-input">
                    </div>
                </div>
            <div class="layui-form-item">
                <label class="layui-form-label">用户说明信息</label>
                <div class="layui-input-inline">
                    <textarea name="UserNote" data-id="UserNote" placeholder="请输入用户说明信息" autocomplete="off" lay-maxlength="2000" class="layui-textarea" style="width:560px"></textarea>
                </div>

            </div>
           
            </div>
            <div class="lastBtn">
                <button class="layui-btn" lay-submit="" lay-filter="sub"><i class="iconfont" style="margin-right:2px;font-size:15px;">&#xe688;</i>保存</button>
                <button class="layui-btn" onclick="ShowWinClose();"><i class="iconfont" style="margin-right:2px;">&#xe63e;</i>关闭</button>
            </div>
        </div>
    </form>
    <!--JS-->
    <script src="~/Scripts/ajaxfileupload.js"></script>
    <script>
        //初始化下拉框单选框（数据从字典获取）
        CreateSelectOptionFromCodeDict($("#Job"), "Job", { width: "100%!important" });
        CreateSelectOptionFromCodeDict($("#JobLevel"), "JobLevel", { width: "100%!important" });
        CreateSelectOptionFromCodeDict($("#UserPosition"), "Position", { width: "100%!important" });
        CreateRadiosFromCodeDict($("#divUserSex"), "UserSex", "Sex");
        //弹出框页面初始化（长宽高等）
        PopupPageInit();
        //初始化组织机构代码下拉框
        GetOrganList();
        function upload_cover(obj) {
            ajax_upload(obj, "User", GetQueryString("userid"), function (data) { //function(data)是上传图片的成功后的回调方法
                $('#image').attr('src', __curHostAddress + data.data); //给<input>的src赋值去显示图片
                $('#UserPhoto').val(data.data);
            });
        }

        var userid = GetQueryString("userid");
        if (userid != "") {
            EWinsBase.json("api/SystemSupport/user/GetUserById", {
                data: { "userid": userid },
                type: "POST",
                async: false,
                usedCache: false,
                success: function (config, data) {
                    if (data.data["UserPhoto"] != "" && data.data["UserPhoto"] != null) {
                        $("#image").attr("src", __curHostAddress + data.data["UserPhoto"]);
                    }
                    $("input:radio[name='UserSex'][value='" + data.data["UserSex"] + "']").attr("checked", 'checked');
                    $("input:radio[name='IsCance'][value='" + data.data["IsCance"] + "']").attr("checked", 'checked');
                    $("input:radio[name='IsSuper'][value='" + data.data["IsSuper"] + "']").attr("checked", 'checked');

                    EWinsBase.setDataModel($("#divData [data-id]"), data.data);

                    $("#labPASSWORD").css("display", "none");
                    $("#divPASSWORD").css("display", "none");
                    $("#PassWord").val("");
                    $("#OrganID").val(data.data["OrganID"]).trigger('change');

                    if (data.data["Job"] != null) {
                        //绑定职务初始值
                        $("#Job").append("<option value=" + data.data["Job"] + ">" + data.data["JobName"] + "</option>");
                        $("#Job").val(data.data["Job"]).trigger('change');
                    }
                    if (data.data["JobLevel"] != null) {
                        //绑定职务级别初始值
                        $("#JobLevel").append("<option value=" + data.data["JobLevel"] + ">" + data.data["JobLevelName"] + "</option>");
                        $("#JobLevel").val(data.data["JobLevel"]).trigger('change');
                    }
                    if (data.data["JobLevel"] != null) {
                        //绑定用户职称初始值
                        $("#UserPosition").append("<option value=" + data.data["UserPosition"] + ">" + data.data["UserPositionName"] + "</option>");
                        $("#UserPosition").val(data.data["UserPosition"]).trigger('change');
                    }


                },
                error: function (error) {
                    //window.location.reload();
                    //
                }
            })
        }
        layui.use(['form', 'layedit', 'laydate'], function () {
            var form = layui.form
                    , layer = layui.layer
                    , layedit = layui.layedit
                    , laydate = layui.laydate;
            laydate.render({
                elem: '#UserBirthday'
            });

            form.on('submit(sub)', function (data) {
                
                data.field["UserID"] = GetQueryString("userid") + "";
                data.field["myaction"] = "UserEdit";
                EWinsBase.json("api/SystemSupport/user/SaveUserInfo", {
                    data: data.field,
                    type: "POST",
                    async: false,
                    usedCache: false,
                    success: function (config, data) {
                        layer.msg(data.msg, { time: 1000 },
                            function () {
                                var cur_tab_index = $(parent.document).find('body .my-body .layui-tab-card > .layui-tab-title .layui-this').attr('lay-id')
                                var wind = $("#tab_iframe_" + cur_tab_index, parent.document)[0].contentWindow;
                                wind.refreshTable();
                                var index = parent.layer.getFrameIndex(window.name);
                                parent.layer.close(index);
                            }
                        );
                    },
                    error: function (error) {
                        //window.location.reload();
                        //
                    }
                })
                return false;
            });
            form.render();
        })
    </script>